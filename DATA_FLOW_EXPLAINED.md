# 数据流程详解

## 📊 Top 30 成交量是如何生成的？

### 1. CSV 文件包含的数据

**文件来源**: `https://files.polygon.io/flatfiles/us_options_opra/day_aggs_v1/YYYY/MM/YYYY-MM-DD.csv.gz`

**文件内容**: ✅ **包含美股市场所有期权合约的交易数据**

```csv
ticker,volume,open,high,low,close,window_start,transactions
O:AAPL250131C00150000,1250,5.2,5.8,5.0,5.5,2025-01-28T00:00:00Z,45
O:AAPL250131C00155000,980,4.1,4.5,3.9,4.3,2025-01-28T00:00:00Z,38
O:AAPL250131P00150000,850,3.2,3.6,3.0,3.4,2025-01-28T00:00:00Z,32
O:SPY250131C00600000,5200,10.1,11.2,9.8,10.9,2025-01-28T00:00:00Z,120
O:SPY250131P00600000,4800,8.5,9.2,8.1,8.8,2025-01-28T00:00:00Z,95
...
(数十万到百万行，每行是一个期权合约)
```

**数据规模估算**:
- 📦 **压缩文件大小**: 50-100 MB
- 📄 **解压后大小**: 200-400 MB
- 📝 **合约数量**: 50万 - 150万+ 条记录
- 🏢 **标的数量**: 估计数千个不同的股票

### 2. 数据处理流程

#### 步骤 1️⃣: 下载和解析 CSV

```python
# src/csv_handler.py line 209-233
def parse_csv(csv_data: bytes) -> pd.DataFrame:
    decompressed = gzip.decompress(csv_data)
    df = pd.read_csv(io.BytesIO(decompressed))
    print(f"✓ Parsed {len(df):,} contracts")  # 例如：解析了 850,234 个合约
    return df
```

**输出**: DataFrame 包含所有期权合约
```
         ticker                    volume  open  high  low   close
0   O:AAPL250131C00150000          1250    5.2   5.8   5.0   5.5
1   O:AAPL250131C00155000           980    4.1   4.5   3.9   4.3
2   O:AAPL250131P00150000           850    3.2   3.6   3.0   3.4
3   O:SPY250131C00600000           5200   10.1  11.2   9.8  10.9
...
850234 行数据
```

#### 步骤 2️⃣: 解析期权 Ticker

```python
# src/csv_handler.py line 185-207
def parse_option_ticker(ticker):
    # 格式: O:SPY250131C00600000
    #       O: 前缀
    #       SPY: 标的股票 ⬅️ 我们提取这个
    #       250131: 到期日
    #       C: Call / P: Put
    #       00600000: 行权价

    return {
        'underlying': 'SPY',      # 标的股票
        'expiry': '250131',
        'contract_type': 'call',
        'strike': 600.0
    }
```

#### 步骤 3️⃣: 按标的股票聚合

```python
# src/csv_handler.py line 235-298
def aggregate_by_underlying(df):
    # 遍历所有唯一的标的股票
    for underlying in ['AAPL', 'SPY', 'TSLA', 'NVDA', ...]:  # 数千个

        # 找到这个标的的所有期权合约
        underlying_df = df[df['underlying'] == underlying]

        # 分别统计 Put 和 Call 的成交量
        put_volume = put_df['volume'].sum()    # 该股票所有 Put 合约成交量之和
        call_volume = call_df['volume'].sum()  # 该股票所有 Call 合约成交量之和
        total_volume = put_volume + call_volume

        results.append({
            'ticker': underlying,          # 标的股票代码
            'total_volume': total_volume,  # 该股票所有期权的总成交量
            'put_volume': put_volume,
            'call_volume': call_volume,
            'contracts_count': len(underlying_df)  # 该股票有多少个期权合约
        })

    # 按总成交量排序
    return sorted(results, key=lambda x: x['total_volume'], reverse=True)
```

**聚合示例**:

```
原始数据（CSV中的多行）:
O:AAPL250131C00150000  volume=1250   ┐
O:AAPL250131C00155000  volume=980    ├─┐
O:AAPL250131P00150000  volume=850    │ │ 所有 AAPL 期权合约
O:AAPL250228C00160000  volume=720    │ │
... (数百个 AAPL 期权合约)            │ │
                                      ┘ │
                                        │
聚合后（一行）:                          ├─> 求和
AAPL  total_volume=125,000  ←──────────┘
      (所有 AAPL 期权合约的总和)
```

#### 步骤 4️⃣: 选取 Top 30

```python
# src/report_generator.py line 38
sorted_data = sorted(data, key=lambda x: x['total_volume'], reverse=True)[:30]
```

**最终输出**: Top 30 成交量最大的标的股票

```
排名  股票   总成交量        说明
1    SPY    5,200,000      SPY 的所有期权合约总成交量
2    QQQ    3,800,000      QQQ 的所有期权合约总成交量
3    NVDA   2,500,000      NVDA 的所有期权合约总成交量
...
30   AAPL     850,000      AAPL 的所有期权合约总成交量
```

### 3. 完整的数据流图

```
┌────────────────────────────────────────────────────────────┐
│  Polygon.io CSV 文件（单日全市场数据）                        │
│  us_options_opra/day_aggs_v1/2025-01-28.csv.gz             │
│                                                             │
│  包含: 50万-150万+ 条期权合约记录                            │
│  ├─ O:AAPL250131C00150000  volume=1250                     │
│  ├─ O:AAPL250131C00155000  volume=980                      │
│  ├─ O:AAPL250131P00150000  volume=850                      │
│  ├─ O:SPY250131C00600000   volume=5200                     │
│  ├─ O:SPY250131P00600000   volume=4800                     │
│  ├─ O:TSLA250131C00300000  volume=3200                     │
│  └─ ... (更多数百万条)                                       │
└────────────────────────────────────────────────────────────┘
                          ⬇️
┌────────────────────────────────────────────────────────────┐
│  步骤1: parse_csv() - 解压并读取                             │
│  DataFrame: 850,234 rows × 8 columns                       │
└────────────────────────────────────────────────────────────┘
                          ⬇️
┌────────────────────────────────────────────────────────────┐
│  步骤2: parse_option_ticker() - 解析每个 ticker              │
│  从 O:AAPL250131C00150000 提取:                             │
│    underlying = 'AAPL'  ⬅️ 标的股票                         │
│    contract_type = 'call'                                  │
│    strike = 150.0                                          │
└────────────────────────────────────────────────────────────┘
                          ⬇️
┌────────────────────────────────────────────────────────────┐
│  步骤3: aggregate_by_underlying() - 按标的聚合               │
│                                                             │
│  AAPL (300个期权合约):                                       │
│    ├─ Call 成交量: 65,000                                   │
│    ├─ Put 成交量:  60,000                                   │
│    └─ 总成交量:    125,000  ⬅️ 输出                          │
│                                                             │
│  SPY (500个期权合约):                                        │
│    ├─ Call 成交量: 2,800,000                                │
│    ├─ Put 成交量:  2,400,000                                │
│    └─ 总成交量:    5,200,000  ⬅️ 输出                        │
│                                                             │
│  ... (数千个股票)                                            │
└────────────────────────────────────────────────────────────┘
                          ⬇️
┌────────────────────────────────────────────────────────────┐
│  步骤4: sorted()[:30] - 按总成交量排序取前30                  │
│                                                             │
│  结果: Top 30 标的股票及其期权总成交量                         │
│  ├─ 1. SPY    5,200,000                                    │
│  ├─ 2. QQQ    3,800,000                                    │
│  ├─ 3. NVDA   2,500,000                                    │
│  └─ ... 30. AAPL  850,000                                  │
└────────────────────────────────────────────────────────────┘
                          ⬇️
┌────────────────────────────────────────────────────────────┐
│  步骤5: 生成 HTML 报告                                       │
│  - 表格显示 Top 30                                          │
│  - 支持点击表头排序                                          │
│  - 图表可视化                                                │
└────────────────────────────────────────────────────────────┘
```

## 🔑 关键要点

### ✅ CSV 文件包含的数据

| 问题 | 答案 |
|------|------|
| **是否包含所有期权？** | ✅ 是的，包含美股市场**所有有交易的期权合约** |
| **数据范围** | 单日全市场期权交易数据 |
| **合约数量** | 50万 - 150万+ 条记录 |
| **标的数量** | 数千个不同的股票 |
| **文件大小** | 50-100 MB (压缩), 200-400 MB (解压) |

### ✅ Top 30 的计算逻辑

1. **不是**选取成交量最大的 30 个期权合约
2. **而是**:
   - 把所有期权合约按标的股票分组
   - 计算每个标的股票的**所有期权合约的总成交量**
   - 选出总成交量最大的 30 个**标的股票**

### 📊 举例说明

**SPY 成交量 5,200,000 的含义**:
```
SPY 当日所有期权合约成交量之和 = 5,200,000

包括:
  O:SPY250131C00590000  +  5,200
  O:SPY250131C00595000  +  4,800
  O:SPY250131C00600000  + 15,000  ⬅️ 这个合约成交量最大
  O:SPY250131C00605000  +  3,500
  O:SPY250131P00590000  +  4,200
  ... (共500+个不同的 SPY 期权合约)
  ─────────────────────────────────
  总计:                    5,200,000
```

## 🎯 优势和局限

### ✅ 优势
- **全市场覆盖**: 不会遗漏任何有交易的期权
- **数据完整**: 包含所有标的股票的所有期权合约
- **处理高效**: 一次下载即可获得全市场数据
- **离线分析**: 下载后可本地快速处理

### ⚠️ 局限
- **不包含持仓量**: CSV 中没有 `open_interest` 字段
- **延迟更新**: 数据在次日11AM ET才可用
- **需要订阅**: Flat Files 功能需要付费订阅

## 🔄 混合策略

当前项目使用的是**混合策略**:

1. **CSV 方式** → 获取全市场交易量数据（快速、完整）
2. **API 方式** → 获取 Top 30 的持仓量数据（精准、补充）

这样既保证了数据的完整性，又补充了 CSV 中缺失的持仓量信息。
