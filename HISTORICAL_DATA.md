# 历史数据生成指南

本项目支持生成历史数据，用于快速测试"10日活跃度"功能。

## 📋 使用场景

### 场景 1: 项目初始化
刚启动项目，想立即看到完整的10日活跃度效果。

### 场景 2: 补充缺失数据
某几天因为故障没有运行，需要补充历史数据。

### 场景 3: 测试功能
开发新功能时需要完整的历史数据进行测试。

## 🚀 使用方法

### 方法一：本地生成（推荐用于初始化）

#### 1. 生成过去10个交易日的数据

```bash
cd /home/feng/code/github/options-anomaly-detector
python generate_historical_data.py --days 10
```

**输出：**
```
======================================================================
历史数据生成工具
======================================================================

模式: 生成过去N个交易日
天数: 10 个交易日
日期范围: 2025-10-17 至 2025-10-30

======================================================================
开始生成 10 天的数据...
======================================================================

生成 2025-10-17 的数据 (距今 13 天)...
  ✓ JSON saved: output/2025-10-17.json
  ✓ HTML saved: output/2025-10-17.html

... (继续生成其他日期)

✅ 完成！共生成 10 天的数据
```

#### 2. 生成单个日期的数据

```bash
python generate_historical_data.py --date 2025-10-25
```

#### 3. 生成日期区间的数据

```bash
python generate_historical_data.py --start 2025-10-20 --end 2025-10-27
```

**自动排除周末：** 脚本会自动跳过周六和周日，只生成交易日数据。

### 方法二：通过 GitHub Actions（远程生成）

1. **访问 GitHub Actions 页面**
   ```
   https://github.com/onlinefchen/options-anomaly-detector/actions
   ```

2. **选择 "Daily Options Analysis" workflow**

3. **点击右侧 "Run workflow" 按钮**

4. **填写参数：**

   | 参数 | 说明 | 示例 |
   |------|------|------|
   | **强制生成历史数据** | 勾选此项启用历史数据生成 | ✅ |
   | **生成过去N个交易日** | 优先级最高，填写后忽略其他日期参数 | `10` |
   | **开始日期** | 单日或区间的起始日期 | `2025-10-20` |
   | **结束日期** | 区间的结束日期（留空则只生成开始日期） | `2025-10-27` |

### 使用示例

#### 示例 1: 快速初始化（生成10天）
```
✅ 强制生成历史数据: true
📊 生成过去N个交易日: 10
📅 开始日期: (留空)
📅 结束日期: (留空)
```

#### 示例 2: 补充特定日期
```
✅ 强制生成历史数据: true
📊 生成过去N个交易日: 0
📅 开始日期: 2025-10-25
📅 结束日期: (留空)
```

#### 示例 3: 补充日期区间
```
✅ 强制生成历史数据: true
📊 生成过去N个交易日: 0
📅 开始日期: 2025-10-20
📅 结束日期: 2025-10-27
```

## 📊 生成后的效果

生成历史数据后，再次运行分析（本地运行 `./run.sh` 或 GitHub Actions 自动运行），你会看到：

### 10日活跃度列显示完整数据

```
排名  股票   ...  10日活跃度
────────────────────────────────
 1    SPY   ...  10/10 🔥 ↔️
                 平均排名: 1.2

 2    QQQ   ...  9/10 🌟 ↓1
                 平均排名: 2.3

 3    NVDA  ...  7/10 🌟 ↑2
                 平均排名: 4.1

 4    TSLA  ...  5/10 ⚡ ↑1
                 平均排名: 6.8

 5    AAPL  ...  3/10 ⚡ ↓2
                 平均排名: 8.3

 6    AMZN  ...  1/10 🆕 ↔️
                 平均排名: 6
```

## 🔄 数据逻辑说明

### 生成的数据特点

1. **模拟真实市场**
   - 基于常见活跃标的（SPY, QQQ, NVDA 等）
   - 成交量和持仓量符合真实范围
   - Top 3 合约包含真实的到期日和行权价

2. **标的出现频率模拟**
   - **常驻嘉宾**（如 SPY, QQQ, NVDA）：90% 概率出现
   - **其他标的**：随机出现，模拟市场热点变化
   - **每日变化**：使用日期作为随机种子，同一日期生成的数据始终相同

3. **数据一致性**
   - 同一日期多次生成，数据完全相同
   - 不会与真实运行的数据冲突
   - 可安全覆盖或补充历史数据

### 与真实数据的区别

| 特性 | 模拟数据 | 真实数据 |
|------|----------|----------|
| **数据来源** | 算法生成 | Polygon API |
| **标的选择** | 预定义列表 + 随机 | 真实市场 Top 30 |
| **成交量/OI** | 合理模拟值 | 真实市场数据 |
| **Top 3 合约** | 随机生成合约信息 | 真实期权合约 |
| **用途** | 测试、初始化 | 生产使用 |
| **标记** | JSON 中含 "模拟数据" 标记 | 无标记 |

## ⚠️ 注意事项

### 1. 数据覆盖

生成历史数据会**覆盖**已有的同日期文件：
```bash
# 如果 output/2025-10-25.json 已存在
python generate_historical_data.py --date 2025-10-25

# ⚠️ 会覆盖原有的 2025-10-25.json 和 2025-10-25.html
```

**建议：**
- 初始化项目时可放心使用
- 补充数据时注意不要覆盖真实运行的数据
- 如需保留真实数据，先备份相应的 JSON 文件

### 2. 自动运行不会生成历史数据

日常的自动运行（每天早上 6:00 AM）**只会生成当天的数据**，不会触发历史数据生成。

**设计逻辑：**
```
定时运行 (cron)     → 只生成今天的数据 ✅
手动触发 (不勾选)   → 只生成今天的数据 ✅
手动触发 (勾选)     → 根据参数生成历史数据 ✅
```

### 3. 周末自动跳过

生成日期区间时，周末会自动跳过：
```bash
python generate_historical_data.py --start 2025-10-20 --end 2025-10-27

# 实际生成（排除周末）:
# 2025-10-20 (周一)
# 2025-10-21 (周二)
# 2025-10-22 (周三)
# 2025-10-23 (周四)
# 2025-10-24 (周五)
# 2025-10-27 (周一)  ← 跳过了 10-25 和 10-26
```

## 🎯 最佳实践

### 推荐流程

1. **项目初始化**
   ```bash
   # 生成过去10个交易日
   python generate_historical_data.py --days 10

   # 运行一次完整分析
   ./run.sh

   # 查看报告，验证10日活跃度列
   open output/anomaly_report.html
   ```

2. **补充缺失数据**
   ```bash
   # 假设 10-23 到 10-25 的数据缺失
   python generate_historical_data.py --start 2025-10-23 --end 2025-10-25

   # 重新运行分析
   ./run.sh
   ```

3. **GitHub Actions 远程生成**
   - 访问 Actions 页面
   - 勾选 "强制生成历史数据"
   - 填写 "10"（生成过去10天）
   - 运行后自动部署到 GitHub Pages

## 📁 文件位置

生成的文件保存在：

```
output/
├── 2025-10-17.json        ← 原始数据（含 "模拟数据" 标记）
├── 2025-10-17.html        ← HTML 报告
├── 2025-10-20.json
├── 2025-10-20.html
├── ...
├── 2025-10-30.json
├── 2025-10-30.html
├── anomaly_report.html    ← 最新报告（main.py 运行后生成）
└── archive.html           ← 归档索引（main.py 运行后生成）
```

## 🔍 验证数据

### 检查生成的数据

```bash
# 查看 JSON 文件
cat output/2025-10-25.json | python -m json.tool | head -30

# 确认数据标记
cat output/2025-10-25.json | grep "模拟数据"
# 输出: "note": "此数据为历史模拟数据，仅用于测试10日活跃度功能"
```

### 验证10日活跃度

生成历史数据后，运行一次分析：
```bash
./run.sh
```

查看报告中的 "10日活跃度" 列：
- ✅ 应该显示 X/10（如 10/10, 9/10）
- ✅ 应该显示图标（🔥 🌟 ⚡ 🆕）
- ✅ 应该显示排名变化（↑↓↔️）
- ✅ 应该显示平均排名

## 💡 常见问题

### Q1: 能否部分使用真实数据，部分使用模拟数据？

**可以。** 模拟数据和真实数据可以混合使用：
```
output/
├── 2025-10-20.json   ← 模拟数据
├── 2025-10-21.json   ← 模拟数据
├── 2025-10-22.json   ← 模拟数据
├── 2025-10-29.json   ← 真实数据（之前运行的）
└── 2025-10-30.json   ← 真实数据（今天运行的）
```

历史分析会同时读取所有 JSON 文件，不区分来源。

### Q2: 如何识别哪些是模拟数据？

查看 JSON 文件中的 `note` 字段：
```json
{
  "date": "2025-10-25",
  "note": "此数据为历史模拟数据，仅用于测试10日活跃度功能",
  ...
}
```

真实数据没有此字段。

### Q3: 模拟数据会影响分析准确性吗？

**不会影响功能测试。** 模拟数据的目的是：
- ✅ 测试 10日活跃度功能
- ✅ 验证 UI 显示效果
- ✅ 快速看到完整的历史统计

**生产环境建议：** 随着时间推移，用真实数据替换模拟数据。

### Q4: 能否在 GitHub Actions 中覆盖真实数据？

**可以，但需谨慎。** 手动触发时勾选"强制生成历史数据"并指定日期，会覆盖该日期的数据。

**建议：** 只在以下情况使用：
- 项目初始化
- 数据损坏需要重新生成
- 测试新功能

---

**开始使用：** 立即运行 `python generate_historical_data.py --days 10` 来初始化你的历史数据！ 🚀
