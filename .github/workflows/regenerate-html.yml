name: Regenerate HTML Reports

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'ğŸ“Š æ›´æ–°æœ€è¿‘Nå¤©çš„HTMLæŠ¥å‘Š'
        required: false
        type: number
        default: 7
      specific_date:
        description: 'ğŸ“… æˆ–è€…ï¼šæŒ‡å®šç‰¹å®šæ—¥æœŸ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''

jobs:
  regenerate:
    name: ğŸ”„ Regenerate HTML Reports
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed for pushing to gh-pages

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“‚ Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-data

      - name: ğŸ”„ Regenerate HTML reports
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          python run.py regenerate-html \
            --days ${{ github.event.inputs.days || 7 }} \
            ${{ github.event.inputs.specific_date && format('--specific-date {0}', github.event.inputs.specific_date) || '' }} \
            --restore-from gh-pages-data

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          keep_files: true  # Keep all existing files
          commit_message: 'ğŸ”„ Regenerate HTML reports (last ${{ github.event.inputs.days }} days)'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          enable_jekyll: false

      - name: âœ… Regeneration summary
        run: |
          echo "=================================================="
          echo "âœ… HTML REGENERATION COMPLETE"
          echo "=================================================="
          echo "ğŸ”— Report URL: https://onlinefchen.github.io/options-anomaly-detector/"
          echo "ğŸ“Š Days processed: ${{ github.event.inputs.days }}"
          echo "=================================================="
