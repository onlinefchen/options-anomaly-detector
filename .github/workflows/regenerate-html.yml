name: Regenerate HTML Reports

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'ğŸ“Š æ›´æ–°æœ€è¿‘Nå¤©çš„HTMLæŠ¥å‘Š'
        required: false
        type: number
        default: 7
      specific_date:
        description: 'ğŸ“… æˆ–è€…ï¼šæŒ‡å®šç‰¹å®šæ—¥æœŸ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''

jobs:
  regenerate:
    name: ğŸ”„ Regenerate HTML Reports
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed for pushing to gh-pages

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“‚ Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-data

      - name: ğŸ’¾ Copy JSON files to output directory
        run: |
          mkdir -p output
          if [ -d "gh-pages-data" ]; then
            echo "ğŸ“Š Copying JSON files from gh-pages..."
            find gh-pages-data -name "*.json" -type f -exec cp {} output/ \; || true
            echo "âœ“ Found $(ls output/*.json 2>/dev/null | wc -l) JSON files"
          else
            echo "âŒ No gh-pages data found"
            exit 1
          fi

      - name: ğŸ”„ Regenerate HTML reports
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          echo "=================================================="
          echo "ğŸ”„ REGENERATING HTML REPORTS"
          echo "=================================================="
          echo ""

          if [ -n "${{ github.event.inputs.specific_date }}" ]; then
            # æŒ‡å®šæ—¥æœŸæ¨¡å¼
            DATE="${{ github.event.inputs.specific_date }}"
            echo "æ¨¡å¼: é‡æ–°ç”Ÿæˆç‰¹å®šæ—¥æœŸ $DATE"

            # Check if date is a trading day
            IS_TRADING_DAY=$(python3 -c "import pandas_market_calendars as mcal; nyse = mcal.get_calendar('NYSE'); date_str = '$DATE'; valid = nyse.valid_days(start_date=date_str, end_date=date_str).size > 0; print('true' if valid else 'false')")

            if [ "$IS_TRADING_DAY" != "true" ]; then
              echo "âŒ $DATE is not a trading day"
              echo "   Only trading days can have valid data"
              exit 1
            fi

            JSON_FILE="output/${DATE}.json"
            if [ -f "$JSON_FILE" ]; then
              echo "âœ“ Found $JSON_FILE, regenerating HTML..."
              python regenerate_html.py "$JSON_FILE"
            else
              echo "âŒ No JSON file found for $DATE"
              exit 1
            fi
          else
            # æœ€è¿‘Nå¤©æ¨¡å¼
            DAYS="${{ github.event.inputs.days }}"
            echo "æ¨¡å¼: é‡æ–°ç”Ÿæˆæœ€è¿‘ $DAYS å¤©çš„HTMLæŠ¥å‘Š"
            echo ""

            # è·å–æ‰€æœ‰JSONæ–‡ä»¶å¹¶æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            JSON_FILES=$(ls -1 output/*.json 2>/dev/null | grep -E '[0-9]{4}-[0-9]{2}-[0-9]{2}\.json$' | sort -r | head -n $DAYS)

            if [ -z "$JSON_FILES" ]; then
              echo "âŒ No JSON files found"
              exit 1
            fi

            COUNT=0
            SUCCESS=0

            for JSON_FILE in $JSON_FILES; do
              COUNT=$((COUNT + 1))
              DATE=$(basename "$JSON_FILE" .json)
              echo "[$COUNT/$DAYS] Processing $DATE..."

              # Check if date is a trading day
              IS_TRADING_DAY=$(python3 -c "import pandas_market_calendars as mcal; from datetime import datetime; nyse = mcal.get_calendar('NYSE'); date_str = '$DATE'; valid = nyse.valid_days(start_date=date_str, end_date=date_str).size > 0; print('true' if valid else 'false')")

              if [ "$IS_TRADING_DAY" != "true" ]; then
                echo "  âŠ˜ Skipped (not a trading day)"
                echo ""
                continue
              fi

              if python regenerate_html.py "$JSON_FILE"; then
                SUCCESS=$((SUCCESS + 1))
                echo "  âœ“ Success"
              else
                echo "  âœ— Failed"
              fi
              echo ""
            done

            echo "=================================================="
            echo "å®Œæˆï¼æˆåŠŸç”Ÿæˆ $SUCCESS/$COUNT ä¸ªHTMLæ–‡ä»¶"
            echo "=================================================="
          fi

      - name: ğŸ“š Regenerate archive index
        run: |
          echo "ğŸ“š é‡æ–°ç”Ÿæˆå½’æ¡£ç´¢å¼•..."
          python src/archive_index_generator.py

      - name: ğŸ“„ Update index.html
        run: |
          # å¤åˆ¶æœ€æ–°æŠ¥å‘Šåˆ° index.html
          LATEST_HTML=$(ls -1 output/*.html 2>/dev/null | grep -E '[0-9]{4}-[0-9]{2}-[0-9]{2}\.html$' | sort -r | head -n 1)

          if [ -n "$LATEST_HTML" ]; then
            cp "$LATEST_HTML" output/index.html
            DATE=$(basename "$LATEST_HTML" .html)
            echo "âœ“ å¤åˆ¶æœ€æ–°æŠ¥å‘Šåˆ° index.html ($DATE)"
          else
            echo "âš ï¸  No HTML files found"
          fi

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          keep_files: true  # Keep all existing files
          commit_message: 'ğŸ”„ Regenerate HTML reports (last ${{ github.event.inputs.days }} days)'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          enable_jekyll: false

      - name: âœ… Regeneration summary
        run: |
          echo "=================================================="
          echo "âœ… HTML REGENERATION COMPLETE"
          echo "=================================================="
          echo "ğŸ”— Report URL: https://onlinefchen.github.io/options-anomaly-detector/"
          echo "ğŸ“Š Days processed: ${{ github.event.inputs.days }}"
          echo "=================================================="
